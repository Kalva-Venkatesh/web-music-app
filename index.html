<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Music App</title>

  <!-- React + Babel for JSX -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Tailwind CSS + FontAwesome + megajs UMD -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://unpkg.com/megajs@1/dist/main.browser-umd.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    :root {
      --bg: #0b0b0c;
      --panel: #101214;
      --muted: #9aa3a8;
      --neon: #1DB954;
      --accent: rgba(29, 185, 84, 0.14);
      --glass: rgba(255, 255, 255, 0.02);
    }
    html, body, #root { height: 100%; }

    @keyframes background-pan {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(29,185,84,0.1), transparent 40%),
                  radial-gradient(900px 500px at 90% 90%, rgba(0,120,255,0.08), transparent 50%),
                  var(--bg);
      background-size: 400% 400%;
      animation: background-pan 35s ease infinite;
      color: #e6eef1;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.05);
      box-shadow: 0 8px 32px rgba(2,6,8,0.7);
      backdrop-filter: blur(10px);
    }
    /* Custom scrollbar for playlist */
    #playlist::-webkit-scrollbar { width: 6px; }
    #playlist::-webkit-scrollbar-track { background: transparent; }
    #playlist::-webkit-scrollbar-thumb { background: var(--neon); border-radius: 999px; }
    #playlist::-webkit-scrollbar-thumb:hover { background: #188944; }

    /* Toasts / Notifications */
    .toast {
        background-color: var(--panel);
        color: var(--neon);
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        border-left: 4px solid var(--neon);
        box-shadow: 0 4px 20px rgba(29, 185, 84, 0.3);
        transform: translateX(120%);
        transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);
    }
    .toast.show { transform: translateX(0); }
    .toast.error { color: #f87171; border-left-color: #f87171; box-shadow: 0 4px 20px rgba(248, 113, 113, 0.3); }

    /* Custom Slider Styles */
    input[type=range].progress-bar {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 999px;
        outline: none;
        cursor: pointer;
    }
    input[type=range].progress-bar::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        background: var(--neon);
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 0 10px var(--neon);
        margin-top: -4px; /* Center thumb on track */
    }
    input[type=range].progress-bar::-moz-range-thumb {
        width: 16px;
        height: 16px;
        background: var(--neon);
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 0 10px var(--neon);
    }
    input[type=range].volume-bar {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 999px;
        outline: none;
        cursor: pointer;
    }
    input[type=range].volume-bar::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 12px;
        height: 12px;
        background: #fff;
        border-radius: 50%;
        cursor: pointer;
        margin-top: -4px;
    }
    input[type=range].volume-bar::-moz-range-thumb {
        width: 12px;
        height: 12px;
        background: #fff;
        border-radius: 50%;
        cursor: pointer;
    }
    /* Custom Select */
    select.speed-select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%239aa3a8%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-13%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2013l128%20128c3.6%203.6%207.8%205.4%2013%205.4s9.4-1.8%2013-5.4l128-128c3.6-3.6%205.4-7.8%205.4-13%200-5-1.8-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
        background-repeat: no-repeat;
        background-position: right 0.5rem center;
        background-size: 0.65em auto;
        padding-right: 2rem;
    }
    select.speed-select option {
        background: var(--panel);
        color: #e6eef1;
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
      .mobile-player {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--panel);
        border-top: 1px solid rgba(255,255,255,0.1);
        padding: 0.75rem;
        z-index: 50;
      }
      .mobile-player .track-info {
        max-width: 60%;
      }
      .mobile-player-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .mobile-mini-player {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .mobile-expanded-player {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--bg);
        z-index: 100;
        padding: 1rem;
        overflow-y: auto;
      }
    }

    /* Loading animation */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .loading-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    /* Image placeholders with gradients */
    .placeholder-gradient-1 {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .placeholder-gradient-2 {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    .placeholder-gradient-3 {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    .placeholder-gradient-4 {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    .placeholder-gradient-5 {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    .placeholder-gradient-6 {
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    }

    /* Optimize animations for performance */
    .will-change-transform {
      will-change: transform;
    }
    .will-change-opacity {
      will-change: opacity;
    }

  </style>
</head>
<body class="overflow-hidden">

  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback, useMemo, useLayoutEffect } = React;

    // --- Configuration for Music Collections ---
    // IMPORTANT: Replace placeholders with your actual public MEGA folder URLs.
    const musicCollections = [
      { 
        name: 'Hanuman Songs', 
        icon: 'fas fa-om', 
        megaUrl: 'https://mega.nz/folder/...',
        image: 'https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=300&h=300&fit=crop&crop=center' // Example image URL
      },
      { 
        name: 'Lo-Fi Beats', 
        icon: 'fas fa-headphones', 
        megaUrl: 'https://mega.nz/folder/...',
        image: 'https://images.unsplash.com/photo-1511379938547-c1f69419868d?w=300&h=300&fit=crop&crop=center'
      },
      { 
        name: 'Workout Hits', 
        icon: 'fas fa-dumbbell', 
        megaUrl: 'https://mega.nz/folder/xMtmxLbT#i7vFt_r_e3iPIn1cINWgbA',
        image: 'https://images.unsplash.com/photo-1534438327276-14e5300c3a48?w=300&h=300&fit=crop&crop=center'
      },
      { 
        name: 'Classical Mood', 
        icon: 'fas fa-guitar', 
        megaUrl: 'https://mega.nz/folder/RcFwjTwK#t5p9O6IfHA5wlG6kaI_Ftg',
        image: 'https://images.unsplash.com/photo-1507838153414-b4b713384a76?w=300&h=300&fit=crop&crop=center'
      },
      { 
        name: 'Podcast Specials', 
        icon: 'fas fa-microphone-alt', 
        megaUrl: 'https://mega.nz/folder/...',
        image: 'https://images.unsplash.com/photo-1478737270239-2f02b77fc618?w=300&h=300&fit=crop&crop=center'
      },
      { 
        name: 'Retro Vibes', 
        icon: 'fas fa-compact-disc', 
        megaUrl: '',
        image: 'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=300&h=300&fit=crop&crop=center'
      },
    ];
    
    // --- Helper Components ---
    const Toast = ({ message, type }) => {
        const [show, setShow] = useState(false);

        useEffect(() => {
            setShow(true);
            const timer = setTimeout(() => {
                setShow(false);
            }, 3000);
            return () => clearTimeout(timer);
        }, []);

        return (
            <div className={`toast ${type} ${show ? 'show' : ''} will-change-transform`}>
                {message}
            </div>
        );
    };

    // Image component with fallback
    const ImageWithFallback = ({ src, alt, className, fallbackIcon = 'fas fa-music' }) => {
      const [hasError, setHasError] = useState(false);
      const [isLoading, setIsLoading] = useState(true);
      
      // Generate a consistent gradient based on the alt text
      const gradientIndex = useMemo(() => {
        let hash = 0;
        for (let i = 0; i < alt.length; i++) {
          hash = alt.charCodeAt(i) + ((hash << 5) - hash);
        }
        return Math.abs(hash) % 6 + 1;
      }, [alt]);

      return (
        <div className={`${className} overflow-hidden flex items-center justify-center`}>
          {!hasError && src ? (
            <img 
              src={src} 
              alt={alt}
              className={`w-full h-full object-cover ${isLoading ? 'loading-pulse' : ''}`}
              onLoad={() => setIsLoading(false)}
              onError={() => {
                setIsLoading(false);
                setHasError(true);
              }}
            />
          ) : (
            <div className={`w-full h-full flex items-center justify-center placeholder-gradient-${gradientIndex}`}>
              <i className={`${fallbackIcon} text-white text-2xl`}></i>
            </div>
          )}
        </div>
      );
    };
    
    // --- Main App Components ---
    const CollectionSelector = ({ onSelectCollection }) => {
        return (
            <div className="flex flex-col items-center justify-center h-full p-4 md:p-8 overflow-y-auto">
                <h1 className="text-4xl md:text-5xl font-bold mb-8" style={{ textShadow: '0 0 15px var(--neon)'}}>My Music App</h1>
                <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4 md:gap-6 w-full max-w-6xl">
                    {musicCollections.map(collection => (
                        <div
                            key={collection.name}
                            onClick={() => collection.megaUrl && onSelectCollection(collection)}
                            className={`
                                panel aspect-square rounded-lg flex flex-col items-center justify-center p-4 text-center
                                transition-all duration-300 transform will-change-transform
                                ${collection.megaUrl ? 'cursor-pointer hover:scale-105 hover:border-neon' : 'opacity-50 cursor-not-allowed'}
                            `}
                            style={collection.megaUrl ? { borderColor: 'rgba(255,255,255,0.05)' } : {}}
                        >
                            <ImageWithFallback 
                              src={collection.image} 
                              alt={collection.name}
                              className="w-16 h-16 md:w-20 md:h-20 rounded-full mb-3"
                              fallbackIcon={collection.icon}
                            />
                            <span className="font-semibold text-sm md:text-base mt-2">{collection.name}</span>
                        </div>
                    ))}
                </div>
            </div>
        );
    };

    const MusicPlayer = ({ collection, onBack }) => {
        const [tracks, setTracks] = useState([]);
        const [currentIndex, setCurrentIndex] = useState(-1);
        const [isPlaying, setIsPlaying] = useState(false);
        const [isLoading, setIsLoading] = useState(true);
        const [currentTime, setCurrentTime] = useState(0);
        const [duration, setDuration] = useState(0);
        const [volume, setVolume] = useState(1);
        const [toasts, setToasts] = useState([]);
        const [shuffle, setShuffle] = useState(false);
        const [repeatMode, setRepeatMode] = useState('off'); // 'off', 'one', 'all'
        const [playbackRate, setPlaybackRate] = useState(1);
        const [searchTerm, setSearchTerm] = useState('');
        const [sortMode, setSortMode] = useState('default'); // 'default', 'title-asc', 'title-desc'
        const [isMobilePlayerExpanded, setIsMobilePlayerExpanded] = useState(false);
        
        const audioRef = useRef(null);
        const blobUrlRef = useRef(null);
        const lastVolumeRef = useRef(1);
        
        // For visualizer
        const canvasRef = useRef(null);
        const audioContextRef = useRef(null);
        const analyserRef = useRef(null);
        const sourceRef = useRef(null);
        const dataArrayRef = useRef(null);
        const animationFrameRef = useRef(null);
        const [isAudioContextInit, setIsAudioContextInit] = useState(false);

        // Performance optimization: Debounce search
        const debouncedSearchTerm = useDebounce(searchTerm, 300);

        const showToast = (message, type = 'success') => {
            const id = Date.now();
            setToasts(prev => [...prev, { id, message, type }]);
            setTimeout(() => {
                setToasts(currentToasts => currentToasts.filter(toast => toast.id !== id));
            }, 3200);
        };

        // Custom hook for debouncing
        function useDebounce(value, delay) {
          const [debouncedValue, setDebouncedValue] = useState(value);
          
          useEffect(() => {
            const handler = setTimeout(() => {
              setDebouncedValue(value);
            }, delay);
            
            return () => {
              clearTimeout(handler);
            };
          }, [value, delay]);
          
          return debouncedValue;
        }

        const fetchTracks = useCallback(async () => {
            setIsLoading(true);
            
            if (!collection.megaUrl || !collection.megaUrl.includes('#')) {
                showToast('Invalid MEGA URL. Please provide a valid link.', 'error');
                setTracks([]);
                setIsLoading(false);
                return;
            }

            try {
                const folder = window.mega.File.fromURL(collection.megaUrl);
                await folder.loadAttributes();
                const audioFiles = folder.children.filter(f => /\.(mp3|m4a|wav|flac)$/i.test(f.name));
                
                if (!audioFiles.length) {
                    showToast('No supported audio files found in this folder.', 'error');
                    setTracks([]);
                    setIsLoading(false);
                    return;
                }
                
                const trackMeta = audioFiles.map((f, i) => ({
                    file: f,
                    title: f.name.replace(/\.[^/.]+$/, ''),
                    filename: f.name,
                    sizeMB: (f.size / 1024 / 1024).toFixed(2),
                    originalIndex: i, // Important: keep original index
                    // Generate a unique image for each track based on title
                    image: `https://picsum.photos/seed/${encodeURIComponent(f.name)}/300/300`
                }));
                setTracks(trackMeta);
            } catch (err) {
                console.error(err);
                showToast('Failed to load folder. Check link/permissions.', 'error');
            } finally {
                setIsLoading(false);
            }
        }, [collection.megaUrl]);

        useEffect(() => {
            fetchTracks();
        }, [fetchTracks]);
        
        // Memoize filtered and sorted tracks
        const filteredAndSortedTracks = useMemo(() => {
            let processedTracks = [...tracks];
            
            // 1. Sort
            if (sortMode === 'title-asc') {
                processedTracks.sort((a, b) => a.title.localeCompare(b.title));
            } else if (sortMode === 'title-desc') {
                processedTracks.sort((a, b) => b.title.localeCompare(a.title));
            }
            // 'default' sorting is the original fetch order, which is already set.

            // 2. Filter
            if (debouncedSearchTerm) {
                processedTracks = processedTracks.filter(track =>
                    track.title.toLowerCase().includes(debouncedSearchTerm.toLowerCase())
                );
            }
            
            return processedTracks;
        }, [tracks, sortMode, debouncedSearchTerm]);

        const revokeBlob = () => {
          if (blobUrlRef.current) {
            try { URL.revokeObjectURL(blobUrlRef.current); } catch (e) {}
            blobUrlRef.current = null;
          }
        };

        const initAudioContext = () => {
            if (isAudioContextInit || !audioRef.current) return;
            
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            const source = audioContext.createMediaElementSource(audioRef.current);
            source.connect(analyser);
            analyser.connect(audioContext.destination);
            
            audioContextRef.current = audioContext;
            analyserRef.current = analyser;
            dataArrayRef.current = dataArray;
            sourceRef.current = source;
            
            setIsAudioContextInit(true);
        };

        const drawVisualizer = () => {
            if (!analyserRef.current || !canvasRef.current) {
                animationFrameRef.current = requestAnimationFrame(drawVisualizer);
                return;
            };

            const analyser = analyserRef.current;
            const canvas = canvasRef.current;
            const ctx = canvas.getContext('2d');
            const dataArray = dataArrayRef.current;
            const bufferLength = dataArray.length;
            
            analyser.getByteFrequencyData(dataArray);
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const barWidth = (canvas.width / bufferLength) * 1.5;
            let x = 0;
            
            for (let i = 0; i < bufferLength; i++) {
                const barHeight = (dataArray[i] / 255) * canvas.height;
                
                ctx.fillStyle = `rgba(29, 185, 84, ${0.5 + (dataArray[i] / 255) / 2})`;
                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                
                x += barWidth + 2; // Add 2 for spacing
            }
            
            animationFrameRef.current = requestAnimationFrame(drawVisualizer);
        };
        
        const playTrack = useCallback(async (originalIndex) => {
            const track = tracks.find(t => t.originalIndex === originalIndex);
            if (!track) return;
            
            setIsLoading(true);
            setCurrentIndex(originalIndex);

            try {
                revokeBlob();
                const data = await track.file.downloadBuffer();
                const mimeType = { mp3:'audio/mpeg', m4a:'audio/mp4', wav:'audio/wav', flac:'audio/flac' }[track.filename.split('.').pop().toLowerCase()] || 'audio/mpeg';
                const blob = new Blob([data], { type: mimeType });
                const url = URL.createObjectURL(blob);
                blobUrlRef.current = url;
                
                if (audioRef.current) {
                    audioRef.current.src = url;
                    audioRef.current.playbackRate = playbackRate;
                    await audioRef.current.play();
                }
            } catch (err) {
                console.error("Failed to play track", err);
                showToast("Failed to load track.", "error");
            } finally {
                setIsLoading(false);
            }
        }, [tracks, playbackRate]);
        
        const handlePlayPause = () => {
            if (!isAudioContextInit) {
                initAudioContext();
            }
        
            if (currentIndex === -1 && tracks.length > 0) {
                playTrack(filteredAndSortedTracks[0].originalIndex);
            } else if (audioRef.current) {
                if (audioRef.current.paused) {
                    audioRef.current.play();
                } else {
                    audioRef.current.pause();
                }
            }
        };

        const handleNext = useCallback(() => {
            if (tracks.length === 0) return;
            
            const currentList = filteredAndSortedTracks;
            const currentListIndex = currentList.findIndex(t => t.originalIndex === currentIndex);

            if (shuffle) {
                let nextIndex;
                do {
                    nextIndex = Math.floor(Math.random() * currentList.length);
                } while (currentList.length > 1 && nextIndex === currentListIndex);
                playTrack(currentList[nextIndex].originalIndex);
                return;
            }
            
            const nextListIndex = currentListIndex + 1;
            if (nextListIndex >= currentList.length) {
                if (repeatMode === 'all') {
                    playTrack(currentList[0].originalIndex);
                }
            } else {
                playTrack(currentList[nextListIndex].originalIndex);
            }
        }, [currentIndex, tracks.length, playTrack, shuffle, repeatMode, filteredAndSortedTracks]);

        const handlePrev = () => {
            if (tracks.length === 0) return;
            if (audioRef.current.currentTime > 3) {
                audioRef.current.currentTime = 0;
            } else {
                const currentList = filteredAndSortedTracks;
                const currentListIndex = currentList.findIndex(t => t.originalIndex === currentIndex);
                
                let prevListIndex = currentListIndex - 1;
                if (prevListIndex < 0) {
                   prevListIndex = currentList.length - 1; // Wrap around
                }
                playTrack(currentList[prevListIndex].originalIndex);
            }
        };
        
        useEffect(() => {
            const audio = audioRef.current;
            const updatePlayingState = () => {
                setIsPlaying(!audio.paused);
                if (!audio.paused) {
                    if (isAudioContextInit) {
                        // Resume context if suspended
                        if (audioContextRef.current.state === 'suspended') {
                            audioContextRef.current.resume();
                        }
                        // Start visualizer
                        animationFrameRef.current = requestAnimationFrame(drawVisualizer);
                    }
                } else {
                    // Stop visualizer
                    cancelAnimationFrame(animationFrameRef.current);
                }
            };
            const updateTime = () => setCurrentTime(audio.currentTime);
            const updateDuration = () => setDuration(audio.duration);
            
            const handleEnded = () => {
                if (repeatMode === 'one') {
                    audio.currentTime = 0;
                    audio.play();
                } else {
                    handleNext();
                }
            };

            audio.addEventListener('play', updatePlayingState);
            audio.addEventListener('pause', updatePlayingState);
            audio.addEventListener('ended', handleEnded);
            audio.addEventListener('timeupdate', updateTime);
            audio.addEventListener('loadedmetadata', updateDuration);

            return () => {
                audio.removeEventListener('play', updatePlayingState);
                audio.removeEventListener('pause', updatePlayingState);
                audio.removeEventListener('ended', handleEnded);
                audio.removeEventListener('timeupdate', updateTime);
                audio.removeEventListener('loadedmetadata', updateDuration);
                revokeBlob();
                cancelAnimationFrame(animationFrameRef.current);
            };
        }, [handleNext, repeatMode, isAudioContextInit]);
        
        const formatTime = (t) => {
            if (!isFinite(t) || t === 0) return '0:00';
            const m = Math.floor(t / 60);
            const s = Math.floor(t % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        };

        const cycleRepeatMode = () => {
            setRepeatMode(prev => {
                if (prev === 'off') return 'all';
                if (prev === 'all') return 'one';
                return 'off';
            });
        };

        const handleVolumeChange = (e) => {
            const newVolume = parseFloat(e.target.value);
            setVolume(newVolume);
            if (audioRef.current) {
                audioRef.current.volume = newVolume;
            }
        };

        const toggleMute = () => {
            if (volume > 0) {
                lastVolumeRef.current = volume;
                setVolume(0);
                if (audioRef.current) audioRef.current.volume = 0;
            } else {
                setVolume(lastVolumeRef.current);
                if (audioRef.current) audioRef.current.volume = lastVolumeRef.current;
            }
        };

        const handleSpeedChange = (e) => {
            const newRate = parseFloat(e.target.value);
            setPlaybackRate(newRate);
            if (audioRef.current) {
                audioRef.current.playbackRate = newRate;
            }
        };
        
        const setSort = (mode) => {
            setSortMode(prev => (prev === mode ? 'default' : mode));
        };

        const currentTrack = tracks.find(t => t.originalIndex === currentIndex);

        // Mobile player components
        const MobileMiniPlayer = () => {
            if (!currentTrack || isMobilePlayerExpanded) return null;
            
            return (
                <div className="mobile-player">
                    <div className="mobile-player-controls">
                        <div className="mobile-mini-player">
                            <ImageWithFallback 
                                src={currentTrack.image} 
                                alt={currentTrack.title}
                                className="w-10 h-10 rounded"
                            />
                            <div className="track-info truncate">
                                <p className="font-semibold truncate">{currentTrack.title}</p>
                                <p className="text-xs text-muted truncate">{collection.name}</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                            <button onClick={handlePlayPause} className="text-neon">
                                <i className={`fas ${isPlaying ? 'fa-pause' : 'fa-play'}`}></i>
                            </button>
                            <button onClick={() => setIsMobilePlayerExpanded(true)}>
                                <i className="fas fa-chevron-up text-muted"></i>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const MobileExpandedPlayer = () => {
            if (!isMobilePlayerExpanded) return null;
            
            return (
                <div className="mobile-expanded-player">
                    <div className="flex flex-col h-full">
                        <div className="flex justify-between items-center mb-6">
                            <button onClick={() => setIsMobilePlayerExpanded(false)} className="text-neon">
                                <i className="fas fa-chevron-down"></i>
                            </button>
                            <h2 className="text-xl font-bold">Now Playing</h2>
                            <div className="w-6"></div> {/* Spacer for alignment */}
                        </div>
                        
                        <div className="flex-1 flex flex-col items-center justify-center">
                            <div className="w-64 h-64 rounded-lg overflow-hidden mb-8">
                                <ImageWithFallback 
                                    src={currentTrack?.image} 
                                    alt={currentTrack?.title || 'Album Art'}
                                    className="w-full h-full"
                                />
                            </div>
                            
                            <h2 className="text-2xl font-bold text-center mb-2">{currentTrack?.title || 'Select a Song'}</h2>
                            <p className="text-muted mb-8">{collection.name}</p>
                            
                            {/* Progress Bar */}
                            <div className="w-full mb-6">
                                <input
                                    type="range"
                                    min="0"
                                    max={duration || 100}
                                    value={currentTime}
                                    onChange={(e) => audioRef.current.currentTime = e.target.value}
                                    className="w-full progress-bar"
                                />
                                <div className="flex justify-between text-xs text-muted mt-1">
                                    <span>{formatTime(currentTime)}</span>
                                    <span>{formatTime(duration)}</span>
                                </div>
                            </div>
                            
                            {/* Controls */}
                            <div className="flex items-center justify-center gap-6 mb-8">
                                <button title="Shuffle" onClick={() => setShuffle(!shuffle)} className={`text-xl ${shuffle ? 'text-neon' : 'text-muted'}`}>
                                    <i className="fas fa-shuffle"></i>
                                </button>
                                <button onClick={handlePrev} className="text-2xl text-muted">
                                    <i className="fas fa-backward-step"></i>
                                </button>
                                <button
                                    onClick={handlePlayPause}
                                    className="w-16 h-16 rounded-full flex items-center justify-center text-3xl"
                                    style={{ background: 'var(--neon)', color: 'var(--bg)', boxShadow: '0 0 25px var(--neon)' }}
                                >
                                    <i className={`fas ${isPlaying ? 'fa-pause' : 'fa-play'}`}></i>
                                </button>
                                <button onClick={handleNext} className="text-2xl text-muted">
                                    <i className="fas fa-forward-step"></i>
                                </button>
                                <button title="Repeat" onClick={cycleRepeatMode} className={`relative text-xl ${repeatMode !== 'off' ? 'text-neon' : 'text-muted'}`}>
                                    <i className="fas fa-repeat"></i>
                                    {repeatMode === 'one' && <span className="absolute text-xs -top-1 -right-2 bg-neon text-bg rounded-full w-4 h-4 flex items-center justify-center font-bold">1</span>}
                                </button>
                            </div>
                            
                            {/* Volume and Speed Controls */}
                            <div className="flex items-center justify-between w-full max-w-sm">
                                <div className="flex items-center gap-2 text-muted">
                                    <i className="fas fa-tachometer-alt"></i>
                                    <select 
                                        value={playbackRate} 
                                        onChange={handleSpeedChange}
                                        className="bg-transparent text-muted text-sm focus:outline-none rounded-md px-2 py-1 speed-select"
                                    >
                                        <option value="0.5">0.5x</option>
                                        <option value="1">1.0x</option>
                                        <option value="1.5">1.5x</option>
                                        <option value="2">2.0x</option>
                                    </select>
                                </div>
                                <div className="flex items-center gap-3 w-1/2 max-w-xs">
                                    <button onClick={toggleMute}>
                                        <i className={`fas ${volume === 0 ? 'fa-volume-xmark' : (volume < 0.5 ? 'fa-volume-low' : 'fa-volume-high')} text-muted`}></i>
                                    </button>
                                    <input
                                        type="range"
                                        min="0"
                                        max="1"
                                        step="0.01"
                                        value={volume}
                                        onChange={handleVolumeChange}
                                        className="w-full volume-bar"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Check if we're on a mobile device
        const isMobile = window.innerWidth <= 768;

        return (
            <div className="flex flex-col h-screen text-white">
                <audio ref={audioRef} preload="auto" crossOrigin="anonymous"></audio>
                <div id="toast-container" className="fixed bottom-5 right-5 z-50 flex flex-col gap-3">
                    {toasts.map(toast => <Toast key={toast.id} {...toast} />)}
                </div>

                {isMobile && <MobileExpandedPlayer />}
                
                <div className={`flex-grow flex flex-col lg:flex-row gap-4 p-4 overflow-hidden ${isMobilePlayerExpanded ? 'hidden' : ''}`}>
                    {/* Left side: Playlist */}
                    <aside className="panel rounded-lg w-full lg:w-1/3 flex flex-col overflow-hidden">
                        <div className="p-4 border-b border-white/10 flex items-center gap-3">
                           <button onClick={onBack} className="text-neon hover:text-white transition-colors"><i className="fas fa-arrow-left"></i></button>
                           <h2 className="text-xl font-bold truncate">{collection.name}</h2>
                        </div>
                        
                        {/* Search and Sort */}
                        <div className="p-3 border-b border-white/10">
                            <div className="relative">
                                <input
                                    type="text"
                                    placeholder="Search tracks..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="w-full bg-white/5 rounded-full py-2 px-4 text-sm pl-10 focus:outline-none focus:ring-1 focus:ring-neon"
                                />
                                <i className="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-muted"></i>
                            </div>
                            <div className="flex items-center gap-2 mt-2">
                                <span className="text-xs text-muted">Sort by:</span>
                                <button
                                    onClick={() => setSort('title-asc')}
                                    className={`text-xs px-3 py-1 rounded-full ${sortMode === 'title-asc' ? 'bg-neon text-bg' : 'bg-white/5 text-muted hover:bg-white/10'}`}
                                >
                                    A-Z <i className="fas fa-arrow-down-a-z ml-1"></i>
                                </button>
                                <button
                                    onClick={() => setSort('title-desc')}
                                    className={`text-xs px-3 py-1 rounded-full ${sortMode === 'title-desc' ? 'bg-neon text-bg' : 'bg-white/5 text-muted hover:bg-white/10'}`}
                                >
                                    Z-A <i className="fas fa-arrow-up-z-a ml-1"></i>
                                </button>
                                {sortMode !== 'default' && (
                                    <button
                                        onClick={() => setSortMode('default')}
                                        className="text-xs text-muted hover:text-white"
                                        title="Clear sort"
                                    >
                                        <i className="fas fa-times"></i>
                                    </button>
                                )}
                            </div>
                        </div>
                        
                        <div id="playlist" className="flex-1 overflow-y-auto p-2 space-y-2">
                           {isLoading && !tracks.length ? (
                               <div className="flex items-center justify-center h-full text-center p-8 text-muted">
                                   <div>
                                       <i className="fas fa-spinner fa-spin text-3xl"></i>
                                       <p className="mt-3">Loading music...</p>
                                   </div>
                               </div>
                           ) : filteredAndSortedTracks.length > 0 ? (
                               filteredAndSortedTracks.map((track) => (
                                   <div 
                                     key={track.filename}
                                     onClick={() => playTrack(track.originalIndex)}
                                     className={`flex items-center gap-4 p-3 rounded-md cursor-pointer transition-all ${currentIndex === track.originalIndex ? 'bg-neon/20 border-l-4 border-neon' : 'hover:bg-white/5'}`}
                                   >
                                      <div className="w-10 h-10 rounded overflow-hidden flex-shrink-0">
                                          <ImageWithFallback 
                                            src={track.image} 
                                            alt={track.title}
                                            className="w-full h-full"
                                          />
                                      </div>
                                      <div className="truncate flex-1">
                                          <p className="font-semibold truncate">{track.title}</p>
                                          <p className="text-xs text-muted">{track.sizeMB} MB</p>
                                      </div>
                                      <div className="text-center w-8 text-muted">
                                          {currentIndex === track.originalIndex && isPlaying ? (
                                              <i className="fas fa-wave-square text-neon"></i>
                                          ) : (
                                              <i className="fas fa-music"></i>
                                          )}
                                      </div>
                                   </div>
                               ))
                           ) : (
                               <div className="text-center p-8 text-muted">
                                {searchTerm ? 'No tracks match your search.' : 'No music found.'}
                               </div>
                           )}
                        </div>
                    </aside>

                    {/* Right side: Player - Hidden on mobile when mini player is active */}
                    {!isMobile && (
                        <main className="panel rounded-lg w-full lg:w-2/3 flex-1 flex flex-col justify-center p-6 md:p-8">
                            <div className="flex flex-col items-center text-center">
                                <div className="w-40 h-40 md:w-52 md:h-52 bg-gradient-to-br from-black/20 to-white/5 rounded-lg overflow-hidden shadow-lg mb-6">
                                    <ImageWithFallback 
                                        src={currentTrack?.image} 
                                        alt={currentTrack?.title || 'Album Art'}
                                        className="w-full h-full"
                                    />
                                </div>
                                <h2 className="text-2xl md:text-3xl font-bold truncate max-w-full">{currentTrack?.title || 'Select a Song'}</h2>
                                <p className="text-muted mt-1">{collection.name}</p>

                                {/* Progress Bar */}
                                <div className="w-full max-w-lg mt-6">
                                    <input
                                        type="range"
                                        min="0"
                                        max={duration || 100}
                                        value={currentTime}
                                        onChange={(e) => audioRef.current.currentTime = e.target.value}
                                        className="w-full progress-bar"
                                    />
                                    <div className="flex justify-between text-xs text-muted mt-1">
                                        <span>{formatTime(currentTime)}</span>
                                        <span>{formatTime(duration)}</span>
                                    </div>
                                </div>
                                
                                {/* Main Controls */}
                                <div className="flex items-center gap-6 mt-6">
                                    <button title="Shuffle" onClick={() => setShuffle(!shuffle)} className={`text-xl transition-colors ${shuffle ? 'text-neon' : 'text-muted hover:text-white'}`}>
                                        <i className="fas fa-shuffle"></i>
                                    </button>
                                    <button onClick={handlePrev} className="text-2xl text-muted hover:text-white transition-colors">
                                        <i className="fas fa-backward-step"></i>
                                    </button>
                                    <button
                                        onClick={handlePlayPause}
                                        className="w-16 h-16 rounded-full flex items-center justify-center text-3xl transition-all transform hover:scale-105"
                                        style={{ background: 'var(--neon)', color: 'var(--bg)', boxShadow: '0 0 25px var(--neon)' }}
                                    >
                                        <i className={`fas ${isPlaying ? 'fa-pause' : 'fa-play'}`}></i>
                                    </button>
                                    <button onClick={handleNext} className="text-2xl text-muted hover:text-white transition-colors">
                                        <i className="fas fa-forward-step"></i>
                                    </button>
                                    <button title="Repeat" onClick={cycleRepeatMode} className={`relative text-xl transition-colors ${repeatMode !== 'off' ? 'text-neon' : 'text-muted hover:text-white'}`}>
                                        <i className="fas fa-repeat"></i>
                                        {repeatMode === 'one' && <span className="absolute text-xs -top-1 -right-2 bg-neon text-bg rounded-full w-4 h-4 flex items-center justify-center font-bold">1</span>}
                                    </button>
                                </div>
                                
                                {/* Visualizer */}
                                <div className="w-full max-w-sm mt-8">
                                    <canvas ref={canvasRef} width="300" height="40" className="w-full h-10"></canvas>
                                </div>
                                
                                {/* Volume and Speed Controls */}
                                <div className="flex items-center justify-between w-full max-w-sm mt-4">
                                    <div className="flex items-center gap-2 text-muted">
                                        <i className="fas fa-tachometer-alt"></i>
                                        <select 
                                            value={playbackRate} 
                                            onChange={handleSpeedChange}
                                            className="bg-transparent text-muted text-sm focus:outline-none rounded-md px-2 py-1 speed-select"
                                        >
                                            <option value="0.5">0.5x</option>
                                            <option value="1">1.0x</option>
                                            <option value="1.5">1.5x</option>
                                            <option value="2">2.0x</option>
                                        </select>
                                    </div>
                                    <div className="flex items-center gap-3 w-1/2 max-w-xs">
                                        <button onClick={toggleMute}>
                                            <i className={`fas ${volume === 0 ? 'fa-volume-xmark' : (volume < 0.5 ? 'fa-volume-low' : 'fa-volume-high')} text-muted`}></i>
                                        </button>
                                        <input
                                            type="range"
                                            min="0"
                                            max="1"
                                            step="0.01"
                                            value={volume}
                                            onChange={handleVolumeChange}
                                            className="w-full volume-bar"
                                        />
                                    </div>
                                </div>
                            </div>
                        </main>
                    )}
                </div>
                
                {/* Mobile Mini Player */}
                {isMobile && <MobileMiniPlayer />}
            </div>
        );
    };


    const App = () => {
        const [selectedCollection, setSelectedCollection] = useState(null);

        if (selectedCollection) {
            return <MusicPlayer collection={selectedCollection} onBack={() => setSelectedCollection(null)} />;
        }
        
        return <CollectionSelector onSelectCollection={setSelectedCollection} />;
    };

    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<App />);
  </script>
</body>
</html>